# Issue #003: 録音の追加・継続機能
**Priority**: Medium
**Assignee**: 
**Labels**: feature, recording, enhancement

## 概要
既存の録音に追加録音できる機能を実装する。

## 要件
- [x] 既存録音への追加録音
- [x] 録音の途中停止・再開
- [x] 追加部分の識別
- [x] 追加録音の取り消し機能

## 技術仕様
- AVAudioRecorder の制御
- 音声ファイルのマージ処理
- セグメント管理

## 完了条件
- [x] 既存録音に追加録音できる
- [x] 追加部分が識別できる
- [x] 追加録音の取り消しができる

## 実装詳細

### 実装した機能

#### セグメント管理システム
- **AudioSegmentモデル**: 個別の追加録音セグメントを管理
- **セグメントID**: 各セグメントの一意識別
- **ファイルパス管理**: `{memoId}_segment{index}.m4a`形式
- **時間管理**: セグメントごとの開始時刻と持続時間

#### VoiceMemoモデルの拡張
- **セグメント配列**: 追加録音セグメントの管理
- **合計時間計算**: メイン録音 + すべてのセグメント
- **全ファイルパス取得**: メイン + セグメントファイルの一覧

#### AudioRecorderの拡張
- **録音モード**: 新規録音 vs 追加録音の区別
- **セグメントインデックス**: 自動的な連番管理
- **追加録音API**: `startAdditionalRecording(for memoId:)`
- **自動保存**: 録音完了時にセグメント情報をCore Dataに保存

#### VoiceMemoControllerの拡張
- **セグメントCRUD操作**:
  - `addSegmentToMemo(memoId:segment:)`: セグメント追加
  - `removeSegmentFromMemo(memoId:segmentId:)`: セグメント削除
  - `getSegmentsForMemo(memoId:)`: セグメント一覧取得
  - `generateSegmentFilePath(memoId:segmentIndex:)`: ファイルパス生成
- **JSONシリアル化**: Core Dataにセグメント情報をJSONで保存
- **ファイル管理**: セグメントファイルの作成と削除

#### VoiceMemoDetailViewのUI改善
- **追加録音ボタン**: メイン操作エリアに追加
- **リアルタイムUI**: 録音中の時間表示と音声レベル
- **セグメント一覧**: 追加されたセグメントの表示と管理
- **個別削除**: セグメント単位での削除機能
- **合計時間表示**: メイン + すべてのセグメントの合計

### 技術的実装方針

#### セグメント管理方式を採用
以下の理由でセグメント管理方式を選択：

1. **技術的制約**: .m4aファイルへの直接追加は複雑
2. **柔軟性**: 各セグメントを個別に管理可能
3. **エラー耐性**: 一部のセグメントが破損しても他は影響なし
4. **編集機能**: 将来的にセグメント単位での操作が可能

#### ファイル命名規則
```
メインファイル: {UUID}.m4a
セグメントファイル: {UUID}_segment0.m4a, {UUID}_segment1.m4a, ...
```

#### データ永続化
- Core Dataの既存モデルを拡張して`segments`フィールドを追加
- JSONエンコードでセグメント情報を保存
- シリアル化可能なAudioSegment構造体

### ユーザーエクスペリエンス

1. **直感的な操作**: 詳細画面から簡単に追加録音が可能
2. **リアルタイムフィードバック**: 録音中の時間と音声レベル表示
3. **柔軟な管理**: セグメント単位での削除と編集
4. **情報の可視化**: 合計時間と個別セグメント情報の表示

### 将来拡張性

この実装により、以下の機能を将来的に追加可能：

1. **セグメントマージ**: AVAssetで複数セグメントを単一ファイルに結合
2. **セグメント並び替え**: ドラッグ&ドロップで順序変更
3. **セグメント再生**: AVQueuePlayerで連続再生
4. **部分文字起こし**: セグメント単位でのAI文字起こし
5. **タイムスタンプ管理**: セグメント間の精密な時間管理

この実装により、基本的な録音アプリから柔軟な追加録音機能を持つ高機能アプリへと進化しました。